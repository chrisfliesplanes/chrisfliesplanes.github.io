<!DOCTYPE html>
<html>
	<head>

		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
										<script src="js/leaflet.polylineDecorator.js"></script>

		<style>
			#mapid { height: 100%; }
			html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
		</style>
	</head>
	<body onload="loadDoc();">
		 <div id="mapid"></div>
		 
		 
		 
		 
		 
		 <script type="text/javascript">
			var markers = []
			var polylines = []
			var symbols = []
			var mymap = L.map('mapid').setView([52.505, -0.09], 8);
			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiY2hyaXN0aGVyb2JpbiIsImEiOiJjaXdoazBsencwMDBlMnZvNHVyMDRwcHY0In0.Lz7E9y59ja6xxFnvmxDTkg', {
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			maxZoom: 18,
			id: 'christherobin.2b1nkjn8',
			accessToken: 'pk.eyJ1IjoiY2hyaXN0aGVyb2JpbiIsImEiOiJjaXdoazBsencwMDBlMnZvNHVyMDRwcHY0In0.Lz7E9y59ja6xxFnvmxDTkg'
			}).addTo(mymap);
			 
			function loadDoc() {
				console.log("I have been called")
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var acList = JSON.parse(this.responseText).acList;
					var filterAcList = filterPlanes(acList);
					setMarkers(filterAcList);
					setTimeout(function(){
		loadDoc();
	}, 5000);
				};
			};
			xhttp.open("GET", "https://taptill.herokuapp.com/radar", true);
			xhttp.send();
			};
			
			function filterPlanes(acList) {
			var filterAcList = [];
			//for (var i = 0; i < acList.length; i++) {
			for(var i in acList){
				var aircraft = acList[i];
				if("Long" in aircraft && "Lat" in aircraft && "Icao" in aircraft && "Cot" in aircraft){
					filterAcList.push(aircraft);
				};
			};
			return filterAcList;
		};
		
		function setMarkers(acList) {
			console.log("This has been run");
			removeMarkers()
			for(var i in acList){
				var aircraft = acList[i];
				var polyCoords = []
				for (var i2 = 0; i2 < aircraft.Cot.length; i2+=3) {
					var polyLatLng = new L.LatLng(aircraft.Cot[i2], aircraft.Cot[i2 + 1])
					polyCoords.push(polyLatLng);
				};
				var polyLinePattern = L.polylineDecorator(polyCoords, {
					patterns: [
						{ offset: '100%', symbol: L.Symbol.marker({rotate: true, markerOptions: {icon: L.icon({iconUrl: 'south.png',iconAnchor: [16,16]})}})}
					]			
				}).addTo(mymap);
				symbols.push(polyLinePattern);
				polyLinePattern.bindPopup(aircraft.Mdl);
			};
		};
		
		function removeMarkers(){
			for(i=0;i<symbols.length;i++){
				mymap.removeLayer(symbols[i])
			}
			markers = [];
			for(i=0;i<markers.length;i++){
				mymap.removeLayer(markers[i])
			}
			markers = [];
			for(i=0;i<polylines.length;i++){
				mymap.removeLayer(polylines[i])
			}
			polylines = [];
		};			 
			 
		</script>
			
	</body>
</html>
